#!/bin/sh

set -eu

. debuilder-paths

. "$DEBUILDER_CONFIG_FILE"

src=$1
srcdir=$(dirname $src)

for dist in $DEBUILDER_DISTS; do
    if [ $# -eq 2 ]; then
	[ "$dist" != "$2" ] && continue
    fi

    sed -n -e '
/^Files:/{
        :loop
        n
        /^$/ q
        s/^ //p
        b loop
}' $src | while read md5 _ filename; do
	filepath=$srcdir/$filename
	echo "$md5  $filepath" | md5sum --check --quiet
	cp --archive --target-directory="$DEBUILDER_SPOOLDIR/$dist" $filepath
    done

    cp --archive --target-directory="$DEBUILDER_SPOOLDIR/$dist" $src
done
