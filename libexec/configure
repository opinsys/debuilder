#!/bin/sh

set -eu

. debuilder-installdirs

. "$DEBUILDER_LIBDIR/common"

mkdir -p /var/lib/debuilder
dbpath=/var/lib/debuilder/rebuildd.db

cat <<EOF > /etc/rebuildd/rebuilddrc
[build]
check_every = 10
max_threads = $DEBUILDER_THREADS
max_jobs = 5
kill_timeout = 90
source_cmd = true
build_cmd = pbuilder --build --debbuildopts $DEBUILDER_BUILDOPTS --aptcache $DEBUILDER_BUILDDIR/aptcache --basetgz /var/cache/pbuilder/debuilder-env.\${d}.\${a}.tgz --buildplace $DEBUILDER_BUILDDIR --buildresult /var/cache/pbuilder/debuilder-result-\${d}-\${a} $DEBUILDER_SPOOLDIR/\${d}/\${p}_\${v}.dsc
post_build_cmd =
dists = $DEBUILDER_DISTS
work_dir = $DEBUILDER_BUILDDIR
database_uri = sqlite://$dbpath
build_more_recent = 1
more_archs = $DEBUILDER_ARCHS
no_system_arch = 1

[mail]
from = debuilder@localhost
mailto = debuilder@localhost
subject_prefix = [debuilder]
smtp_host = localhost
smtp_port = 25

[telnet]
port = 9999
ip = 127.0.0.1
prompt = debuilder@localhost->
motd = Connected on debuilder on localhost

[http]
port = 9998
ip = 0.0.0.0
log_lines_nb = 30
templates_dir = /usr/share/rebuildd/templates
cache = 1
logfile = /var/log/debuilder/rebuildd-httpd.log

[log]
file = /var/log/debuilder/rebuildd.log
time_format = %Y-%m-%d %H:%M:%S
logs_dir = /var/log/debuilder/builds
mail_failed = 0
mail_successful = 0
EOF

[ -f "$dbpath" ] || rebuildd init
