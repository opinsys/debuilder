#!/bin/bash

set -o posix
set -eu

debuilder_on_exit()
{
    # Save the status code of the previous command, i.e. the reason why
    # we are exiting.
    local -r exitval=$?

    # We are already exiting and doing some cleanups. We do not want to
    # exit early.
    set +e

    # Kill all child processes we spawned.
    for pidfile in $DEBUILDER_RUNDIR/*.pid; do
        local childpid=$(cat "$pidfile")
        echo "Killing child [$childpid]"
        kill -TERM "$childpid"
        rm "$pidfile"
    done

    rmdir "$DEBUILDER_RUNDIR"

    # Remove all signal handlers and exit with the original status.
    trap - EXIT
    exit $exitval
}

if [ $# -eq 1 ]; then
    if [ "$1" = "--daemon" ]; then
        daemon --noconfig --name='debuilder' -- debuilder
        exit 0
    fi
    echo "debuilder: error: unexpected argument '$1'" >&2
    exit 1
fi


# Get essential directory paths defined at installation time.
. debuilder-installdirs

. "$DEBUILDER_LIBDIR/common"

# Update runtime configuration.
. "$DEBUILDER_LIBDIR/configure"

# Prepare to cleanup on exit.
trap debuilder_on_exit EXIT

mkdir -p "$DEBUILDER_RUNDIR"
mkdir -p "$DEBUILDER_LOGDIR/builds"
mkdir -p "$DEBUILDER_BUILDDIR/aptcache"

rebuildd &
echo $! 1>"$DEBUILDER_RUNDIR/rebuildd.pid"

rebuildd-httpd &
echo $! 1>"$DEBUILDER_RUNDIR/rebuildd-httpd.pid"

for dist in $DEBUILDER_DISTS; do
    inoticoming \
        --foreground \
        "$DEBUILDER_SPOOLDIR/$dist" \
        --chdir "$DEBUILDER_SPOOLDIR/$dist" \
        --suffix .dsc \
        "${DEBUILDER_LIBDIR}/add-rebuildd-job" {} "$dist" \; \
        2>&1 1>>"$DEBUILDER_LOGDIR/inoticoming-$dist.log" &
    echo $! 1>"$DEBUILDER_RUNDIR/inoticoming-$dist.pid"
done

wait
